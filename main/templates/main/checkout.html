{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - Variety by Oge{% endblock %}

{% block content %}
<!-- CSRF Token -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div x-data="checkoutApp()" x-init="initCart()" class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Checkout</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2">Complete your purchase with secure payment</p>
    </div>

    <!-- Empty Cart Message -->
    <div x-show="cart.items.length === 0" class="text-center py-12">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-8 max-w-md mx-auto">
            <div class="w-20 h-20 mx-auto mb-6 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
                <i class="fas fa-shopping-cart text-3xl text-gray-400"></i>
            </div>
            <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Your Cart is Empty</h2>
            <p class="text-gray-600 dark:text-gray-300 mb-6">Add some items to your cart before checking out.</p>
            <a href="/" class="inline-block bg-primary-600 hover:bg-primary-700 text-white py-3 px-6 rounded-lg transition-colors shadow-md hover:shadow-lg">
                Continue Shopping
            </a>
        </div>
    </div>

    <!-- Checkout Form -->
    <div x-show="cart.items.length > 0" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Customer Information -->
        <div class="lg:col-span-2">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <span class="w-8 h-8 bg-primary-100 dark:bg-primary-900/30 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-user text-primary-600"></i>
                    </span>
                    Customer Information
                </h2>
                
                <form @submit.prevent="submitOrder">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="full_name" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Full Name *</label>
                            <input x-model="formData.full_name" type="text" id="full_name" required
                                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors"
                                   placeholder="Enter your full name">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Email *</label>
                            <input x-model="formData.email" type="email" id="email" required
                                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors"
                                   placeholder="your.email@example.com">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="phone" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Phone Number *</label>
                            <input x-model="formData.phone" type="tel" id="phone" required
                                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors"
                                   placeholder="+234 800 000 0000">
                        </div>
                        <div class="md:col-span-2">
                            <label for="address" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Delivery Address *</label>
                            <textarea x-model="formData.address" id="address" required rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors"
                                      placeholder="Enter your complete delivery address"></textarea>
                        </div>
                    </div>
                    
                    <!-- Payment Method -->
                    
                    
                    <div class="mt-8">
                        <button type="submit" :disabled="isSubmitting || cart.items.length === 0"
                                class="w-full bg-primary-600 hover:bg-primary-700 text-white py-4 px-6 rounded-lg transition-colors shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                            <span x-show="!isSubmitting" class="flex items-center">
                                <i class="fas fa-lock mr-3"></i>
                                Pay - ₦<span x-text="cartTotal.toFixed(2)"></span>
                            </span>
                            <span x-show="isSubmitting" class="flex items-center justify-center">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Processing...
                            </span>
                        </button>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-3 text-center">
                            <i class="fas fa-shield-alt mr-1"></i> Your payment information is secure and encrypted
                        </p>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Order Summary -->
        <div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 sticky top-6">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <span class="w-8 h-8 bg-primary-100 dark:bg-primary-900/30 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-receipt text-primary-600"></i>
                    </span>
                    Order Summary
                </h2>
                
                <div class="divide-y divide-gray-200 dark:divide-gray-700 mb-6 max-h-96 overflow-y-auto" x-show="cart.items.length > 0">
                    <template x-for="item in cart.items" :key="item.id">
                        <div class="py-4 first:pt-0 last:pb-0">
                            <div class="flex items-start justify-between">
                                <div class="flex items-center flex-1">
                                    <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-md overflow-hidden mr-4 flex-shrink-0 flex items-center justify-center">
                                        <img :src="item.image || '/static/img/placeholder.jpg'" 
                                             :alt="item.name" 
                                             class="w-full h-full object-cover"
                                             onerror="this.src='/static/img/placeholder.jpg'">
                                    </div>
                                    <div class="flex-1">
                                        <h3 x-text="item.name" class="font-medium text-gray-900 dark:text-gray-100 text-sm"></h3>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                            Qty: <span x-text="item.quantity || 1"></span>
                                        </p>
                                        <p class="text-xs text-primary-600 dark:text-primary-400 mt-1">
                                            ₦<span x-text="((item.price || 0) / (item.quantity || 1)).toFixed(2)"></span> each
                                        </p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-medium text-gray-900 dark:text-gray-100">
                                        ₦<span x-text="(item.price || 0).toFixed(2)"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4" x-show="cart.items.length > 0">
                    <div class="space-y-3">
                        <div class="flex justify-between text-gray-600 dark:text-gray-300">
                            <span>Subtotal</span>
                            <span>₦<span x-text="cartTotal.toFixed(2)"></span></span>
                        </div>
                        <div class="flex justify-between text-gray-600 dark:text-gray-300">
                            <span>Delivery Fee</span>
                            <span class="text-green-600 dark:text-green-400">Free</span>
                        </div>
                        <div class="flex justify-between text-gray-600 dark:text-gray-300">
                            <span>Tax</span>
                            <span>₦<span x-text="(cartTotal * 0.075).toFixed(2)"></span></span>
                        </div>
                        <div class="flex justify-between font-bold text-lg text-gray-900 dark:text-gray-100 pt-3 border-t border-gray-200 dark:border-gray-700">
                            <span>Total</span>
                            <span>₦<span x-text="(cartTotal * 1.075).toFixed(2)"></span></span>
                        </div>
                    </div>
                </div>

                
            </div>

           
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div x-show="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-cloak>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Confirm Your Order</h2>
                    <button @click="showModal = false" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <h3 class="font-medium mb-3">Order Summary</h3>
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <div class="divide-y divide-gray-200 dark:divide-gray-600">
                            <template x-for="item in orderData.items || []" :key="item.name">
                                <div class="py-2 flex justify-between">
                                    <div>
                                        <span x-text="item.name" class="font-medium"></span>
                                        <span class="text-gray-500 dark:text-gray-400"> × </span>
                                        <span x-text="item.quantity" class="text-gray-500 dark:text-gray-400"></span>
                                    </div>
                                    <div class="font-medium">
                                        ₦<span x-text="item.total || ((parseFloat(item.price || 0) * (item.quantity || 1)).toFixed(2))"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <div class="border-t border-gray-200 dark:border-gray-600 pt-3 mt-3">
                            <div class="flex justify-between font-bold text-lg">
                                <span>Total</span>
                                <span>₦<span x-text="orderData.total || '0.00'"></span></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="font-medium mb-2">Delivery Information</h3>
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-sm">
                        <p class="mb-1"><strong>Name:</strong> <span x-text="formData.full_name"></span></p>
                        <p class="mb-1"><strong>Email:</strong> <span x-text="formData.email"></span></p>
                        <p class="mb-1"><strong>Phone:</strong> <span x-text="formData.phone"></span></p>
                        <p><strong>Address:</strong> <span x-text="formData.address"></span></p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button @click="showModal = false" 
                            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-700 dark:text-gray-300">
                        <i class="fas fa-edit mr-2"></i>
                        Edit Details
                    </button>
                    <button @click="proceedToPayment" 
                            :disabled="!orderData.payment_link"
                            class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-credit-card mr-2"></i>
                        Proceed to Payment
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('checkoutApp', () => ({
        cart: { items: [] },
        formData: {
            full_name: '',
            email: '',
            phone: '',
            address: ''
        },
        isSubmitting: false,
        showModal: false,
        orderData: {},
        
        initCart() {
            // Get cart from the store
            this.cart = Alpine.store('cart').getCart();
            console.log('Cart initialized:', this.cart);
            
            // Redirect if cart is empty
            if (!this.cart.items || this.cart.items.length === 0) {
                console.log('Cart is empty');
                // Don't redirect immediately, let user see empty cart message
            }
        },
        
        get cartTotal() {
            if (!this.cart.items || this.cart.items.length === 0) {
                return 0;
            }
            return this.cart.items.reduce((total, item) => {
                const price = parseFloat(item.price || 0);
                return total + price;
            }, 0);
        },
        
        async submitOrder() {
            console.log('Submitting order...');
            
            // Validate form
            if (!this.formData.full_name.trim() || !this.formData.email.trim() || 
                !this.formData.phone.trim() || !this.formData.address.trim()) {
                Alpine.store('notify').error('Please fill in all required fields');
                return;
            }
            
            // Validate cart
            if (!this.cart.items || this.cart.items.length === 0) {
                Alpine.store('notify').error('Your cart is empty');
                return;
            }
            
            this.isSubmitting = true;
            
            try {
                // Prepare order data
                const orderData = {
                    items: this.cart.items.map(item => ({
                        id: parseInt(item.id.toString().split('_')[0]) || item.id, // Handle both regular and suffixed IDs
                        quantity: parseInt(item.quantity) || 1
                    })),
                    full_name: this.formData.full_name.trim(),
                    email: this.formData.email.trim(),
                    phone: this.formData.phone.trim(),
                    address: this.formData.address.trim()
                };
                
                console.log('Order data:', orderData);
                
                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                 document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '{{ csrf_token }}';
                
                // Send to server
                const response = await fetch('{% url "process_checkout" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(orderData)
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Show confirmation modal with order details
                this.orderData = data;
                this.showModal = true;
                console.log('Order processed successfully');
                
            } catch (error) {
                console.error('Order submission error:', error);
                Alpine.store('notify').error('Error processing order: ' + error.message);
            } finally {
                this.isSubmitting = false;
            }
        },
        
        proceedToPayment() {
            console.log('Proceeding to payment...');
            
            if (!this.orderData.payment_link) {
                Alpine.store('notify').error('Payment link not available');
                return;
            }
            
            // Open payment link in new tab
            const paymentWindow = window.open(this.orderData.payment_link, '_blank', 'noopener,noreferrer');
            
            if (!paymentWindow) {
                Alpine.store('notify').error('Please allow popups to proceed with payment');
                return;
            }
            
            // Close modal
            this.showModal = false;
            
            // Clear cart after successful order
            Alpine.store('cart').clear();
            
            // Show success message
            Alpine.store('notify').success('Redirecting to payment gateway...');
            
            console.log('Payment window opened successfully');
        }
    }));
});
</script>
{% endblock %}